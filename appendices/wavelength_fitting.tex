%!TEX root = ../thesis.tex

\chapter{Multi-detector wavelength calibration} % Main appendix title
\label{appendix:wavelength_fitting}

In this Appendix an example of multi-detector wavelength calibration is provided.
This is to try and improve the wavelength calibration on the detectors in which a limited number of telluric lines fall.

The spectrum recorded across the four detectors is created from a single dispersion and should, in theory, be able to be modelled by a single polynomial.
\cref{fig:multidectorfit} shows the pixel-wavelength calibrating points for the 4 detectors, along with the individual fits, extended over the four detectors.
At this scale all four lines are basically similar except for the fourth detector near the wavelength region of detector 1 where it is slightly higher.
On top is also a line indicating a polynomial fit made using the points from all four detectors and including the fixed gaps between detectors.

\cref{fig:multidectorfitdiff} shows the difference between the individual detectors and the combined fit.
Within the individual detectors the absolute wavelength difference is less than 0.5\nm{} at the edges of detector one, however the differences exceed 0.3\nm{} outside of the original detector.
They are quadratic in shape as they are the difference between two quadratics.

\begin{figure}
    \centering
    \includegraphics[width=0.7\linewidth]{./figures/appendix/combined_wav_fit}
    \caption[Multi-detector fit and difference to individual fits.]{Pixel-wavelength calibration points for each detector are given by the different markers.
    The quadratic fit of each individual detector is given with the same corresponding colour.
    A combined quadratic fit, using fixed detector gaps is shown in black.}
    \label{fig:multidectorfit}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.7\linewidth]{./figures/appendix/difference_combined_wav_fit}
    \caption[Difference of multi-detector combined fit to the individual calibration mappings.]{Wavelength difference of individual quadratic fits to the quadratic fit combined all four detectors and fixed gaps.}
    \label{fig:multidectorfitdiff}
\end{figure}

The combined fit is made by first assigning each horizontal pixel of each detector the position between 0 and 4095 in pixel coordinates of the {CRIRES} detectors.
A transformation is made into a psudo-physical pixel coordinates from the left edge of the first detector by including the gaps between the detectors (in pixels).
The parameters \(gap_{1}\), \(gap_{2}\), \(gap_{3}\) are the 3 gaps between neighbouring detectors gaps and are defined in pixel space as follows:
\[
gap =\begin{cases}
0,                       & ~~~~0=<pxl<1024\\
gap_1,                    & 1024=<pxl<2048\\
gap_1 + gap_2,             & 2048=<pxl<3072\\
gap_1 + gap_2 + gap_3,      & 3072=<pxl<4096
\end{cases}
\]

The pixel widths of these gaps can be fixed to known values (e.g.\ 282, 278, and 275 pixels~\citep{brogi_rotation_2016}) or allowed to vary and included in the fitting process.


\section{Comparing variable gaps}

%\begin{figure}
%    \centering
%    \includegraphics[width=0.7\linewidth]{./figures/appendix/multidetecot_param_fit}
%    \caption[Multi-detector parameter correlations.]{Corner plot of emcee combined fitting.
%    The elliptical point clouds indicate there are correlations between parameters.}
%    \label{fig:multidetecotparamfit}
%\end{figure}

This example does not include the height on the detectors the spectrum falls or any skewness of the spectrum to pixel rows or any miss-alignment between the detectors.
All which could have some affect on a global wavelength calibration.

\cref{tab:example_calibration_parameters} shows the fit parameters obtained as well as some fit statistics for quadratic and cubic fitting, comparing the full combined fit with fixed or variable gaps.

\cref{fig:quadcornerplots} also show the distribution of the fit parameters for the quadratic fit with fixed (left) and variable gaps (right) obtained using the \textit{emcee} python package\footnote{\href{http://dfm.io/emcee/current/}{http://dfm.io/emcee/current/}}, which performs a Markov chain Monte Carlo simulation.
The cloud of points reveal the correlations between different parameters.
For instance the narrow diagonals indicate a strong correlation between the parameters given on the axis.
There are strong correlations between the quadratic parameters, {q, m, b} with $m$ being negatively correlated to all other parameters.
It also shows strong positive correlations between the variable detector gaps.

They plot on the left with fix detector gaps, is almost identical to the top 3 rows of the figure on the right.


\input{./tables/appendices/wavelength_mapping_table}

\begin{figure}
    \centering
    \begin{tabular}{c c}
    \includegraphics[width=0.4\linewidth]{figures/appendix/fixed_quad_corner} & \includegraphics[width=0.45\linewidth]{figures/appendix/variable_quad_corner} \\
    \end{tabular}
    \caption[Multi-detector calibration parameter correlations.]{Corner plots of combined fitting of four detectors.
    The elliptical point clouds indicate there are correlations between parameters.
    (left) Combined fit with fixed detector gaps.
    (right) Combined fit with variable detector gaps.}
    \label{fig:quadcornerplots}
\end{figure}

This is just a simple representation of the idea, it has not been used in this thesis for wavelength calibration

\todo{reread and fix up still}