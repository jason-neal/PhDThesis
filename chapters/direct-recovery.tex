%!TEX root = ../thesis.tex
%3-Direct-Spectral-Recovery
% Shift and subtract Method
% Calculation of planet RV 
% Similation of spectral recovery
% RV difference effect on amplitude of signal simulation
% Chisquared method of model plus stellar at different RVs? technique
% Limitations? 
% Future Prospects 
% CRIRES+, JWST
% Calculation of exposure time required etc?


\chapter{Direct-Spectral-Recovery}  % Main chapter title

\label{cha:Chapter3} 

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------

\section{Main Section 1}



%-----------------------------------
%	SUBSECTION 1
%-----------------------------------
\subsection{Subsection 1}


%-----------------------------------
%	SUBSECTION 2
%-----------------------------------

\subsection{Subsection 2}

%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{Main Section 2}



% from draft of paper 18/7/2017
\subsection{Companion K}
\label{sec:companion_RV}
\emph{These sections might be unnecessary}\\

To calculate the RV of the companion at the time of each observation. For a two-body system the RV semi-amplitude of the companion $\textrm{K}_{2}$ can be determined from the orbital host-companion mass ratio $q = \textrm{M}_{1}/\textrm{M}_{2} = \textrm{K}_{2}/\textrm{K}_{1}$.
Note, that for the targets in which only the minimum mass (msini) is known, this will give the maximum RV semi-amplitude of the companion.
This relation was used to estimate $\textrm{K}_2$ for the companion from the minimum mass or mass we have for each companion. These values along with the other orbital parameters of the system were use to calculate the RV of the companions for each observation. These values are provided with the observations in Table~\ref{tab:observations}.


\subsection{Companion-host Flux ratio}
The companion-host flux or contrast ratio of the systems are calculated using $ \frac{F_{2}}{F_{1}} \approx 2.512^{m_1-m_2} $, where $m_1$ and $m_2$ are the magnitude of the host and companion respectively.\ $m_1$ is the observed magnitude of the host while $m_2$ is obtained from stellar evolution models of \citet{baraffe_evolutionary_2003, baraffe_new_2015}, using the companion mass or minimum mass and the host age. The models, interpolated to the companion mass, also provide a first estimate of companion properties such as $T_{eff}$, $R/R_{\odot}$ and the magnitude in many wavelength bands.
We use the K band magnitude specifically for this work to estimate the flux ratio between the host and companion using and the host K band magnitude obtained from SIMBAD \citep{wenger_simbad_2000}. Our flux ratio estimates are presented in table~\ref{tab:flux_table}.

If only the companion minimum mass is known then this will correspond to the flux ratio lower limit, (or worst case scenario).


A simple tool to do this calculation was created with python. Given a host name, companion mass and a stellar age it can give a flux contrast ratio of the system. A script to work backwards from a flux-ratio to a companion mass was also created as a check for the results from \S~\ref{subsec:companion_recovery}. These scripts can be found at \url{https://github.com/jason-neal/baraffe_tables}.


\subsection{CRIRES data}
\label{subsec:CRIRES}
Observations were performed with the CRIRES instrument~\citep{kaeufl_crires_2004} configured to observe a narrow wavelength domain of the K-band between \(\rm2120-2160~nm \) using the Ks and the Hx5e-2 filters. The slit width of \(0.4\sec \) resulted in an instrumental resolving power of R\(\sim50000 \), with no adaptive optics to ensure that the slit was entirely covered by each target.

The observations were performed in service mode during period 89 with run ID.~089.C-0977(A) between April and August 2012. An observation is composed of 8 individual spectra with an integration time of 180 seconds, observed in the ABBAABBA nod cycle pattern to obtain a high (>100) signal-to-noise when combined. The targets and observation times taken by CRIRES are provided in Table~\ref{tab:observations}.




TAPAS XML REQUESTER

Although TAPAS provides a convenient web-interface to retrieve telluric spectra, it is tedious to use when requesting many models. A script\footnote{Can be found at \url{github.com/separate repo}} was used to automatically fill-out the XML template provided by TAPAS directly from values in the header information of each observation. Although created for these CRIRES observations it could be adjusted to work with other instruments if many TAPAS spectra are required. \textbf{It can be found at \ldots. Make separate Github repo for TAPAS requests.}


\input{./tables/stellar_params}
\input{./tables/orbital_params}
\input{./tables/flux_calculations}
\input{./tables/observations}



CHECK out LOCKWOOD 2014 - maximum likelyhood with todcor   1e-4 flux ratio double lined spectra




\section{Differential subtraction}
\label{sec:spec_diff}

The observations were gathered having in mind the application of a differential subtraction method \citep[e.g.][]{ferluga_separating_1997, kostogryz_spectral_2013} to detect the spectra of the faint BD companions. In short, we Doppler shift each observation to the rest frame of the host star and then mutually subtract the spectra from pairs of observations to cancel out the spectra of the brighter host star. The residuals from this method should contain two copies of the faint companion, subtracted from each other with a radial velocity offset \(\Delta RV\), one positive and one negative. This RV offset, if detectable, would allow the mass ratio to be determined and hence the companion mass. 

Due to the poorly separated observation times relative to the long orbital periods, this method was revealed to be inappropriate for these observations as the RV separation of the companion spectra between observations (\(\le 2.3\)~kms\(^{-1}\)) is significantly smaller than the FWHM (full width half maximum) of individual spectral lines (\(\sim\)6~kms\(^{-1}\) at \(\rm R=50\,000\)).  The small separation of the companion causes the lines of the companion to also mutually cancel, severely reducing the residual signal to well below the available noise level. The requirement of well separated RVs for the companion spectra was clearly stated in the original proposal but was not satisfied when the observations were obtained\footnote{see Sect.~\ref{subsubsec:differential scedualing} for more details}. Radial velocity constraint are also valid for other studies such as the detection of reflected light from exoplanets \cite{martins_evidence_2015}. The estimated companion \(\Delta RV\) separation between the furthermost observational pair for each target is provided in the fifth column of Table~\ref{tab:flux_table}. 

Despite these problems, we still tried to apply the method to our data. Given the negative result, however, we decided to move this section to Appendix~\ref{appendix:A1}, where we describe the method and some exploratory results that may be useful for future studies.



\section{Direct Subtraction Method}
\label{appendix:A1}
Here we outline the direct subtraction method used, which is similar to previous works \citep{ferluga_separating_1997,kostogryz_spectral_2013}. Assuming that the instrumental profile and atmospheric absorption are dealt with appropriately, the spectrum received from the host-companion pair is given by the superposition of two spectral components (\(J_{1} \), \(J_{2} \)), where \(\lambda-v\) represents the Doppler shift \(\lambda(1-v/c)\) by velocity \(v\).
\begin{equation}
\textrm{I}(\lambda) = \textrm{J}_{1}(\lambda - v_{1}) + \textrm{J}_{2}(\lambda - v_{2})
\end{equation}
or shifted to the host stars rest frame,
\begin{equation}
\textrm{I}(\lambda + v_{1}) = \textrm{J}_{1}(\lambda) + \textrm{J}_{2}(\lambda - v_{2} + v_{1})
\end{equation}
Here, the subscripts 1 and 2 indicate the spectrum of the host and companion respectively, and \(\lambda \) represents the wavelength of the spectra.
The spectra of the host star (\(\textrm{J}_{1} \)) is removed though the mutual subtraction of the host spectrum from two separate observations, denoted with subscripts \(a\) and \(b\), correcting for RV motion of the host star.
\begin{align}
	S(\lambda) &= \textrm{I}_{a}(\lambda + v_{1a}) - \textrm{I}_{b}(\lambda + v_{1b}) \nonumber \\
	&= \textrm{J}_{2}(\lambda - v_{2a} + v_{1a}) - \textrm{J}_{2}(\lambda - v_{2b}  + v_{1b}) \nonumber \\
	%  &= \textrm{J}_{2}(\lambda - v_{2a}) - \textrm{J}_{2}(\lambda - v_{2b} - v_{1a} + v_{1b}) \nonumber \\
	S(\lambda + v_{2a}) &= \textrm{J}_{2}(\lambda) - \textrm{J}_{2}(\lambda + \Delta RV )  \label{eqn:sprofile}
\end{align}
where,
\begin{equation}
\Delta RV = v_{2a} - v_{2b} - v_{1a} + v_{1b} \label{eqn:k}
\end{equation}

is the actual RV difference (\(\Delta RV \)) between the two companion spectra.

The resulting differential spectra, dubbed \emph{s-profile} by \citet{ferluga_separating_1997}, is composed of just the companion spectra, shifted and subtracted from itself.

From binary dynamics \citep[e.g.][]{murray_keplerian_2010} the RV amplitudes of the host and companion are related through the mass ratio, \(q \), while having an opposite sign.
\begin{align}
	v_{2}  &= -\textrm{q} * v_{1} \label{eqn:q_relation}
\end{align}
This equation was used to calculate the expected companion RV for each observation in Table~\ref{tab:observations}. 

We can simplify Eq.~\ref{eqn:k} by expressing it in terms of the host RV and mass ratio,
\begin{align}
	k &= -q v_{1a} + q v_{1b} + v_{1a} - v_{1b} \nonumber \\
	&= (1 - \textrm{q})(v_{1a} - v_{1b}). \label{eqn:k_simplified}
\end{align}
If we are able to determine the \(\Delta RV \) between the the companion spectra, k, from the s-profile \citep[see ][]{ferluga_separating_1997} then we can determine the mass ratio of the system, q, thereby constraining the mass of the companion. The values \(v_{1a} \) and \(v_{1b} \) are calculated from the orbital parameters of the system and are the same values already used to shift and mutually cancel the host spectrum.

This method is very similar to \citet{kostogryz_spectral_2013} except that they focus on M-dwarfs host stars with the observations taken at the extrema, in which the companion lines are well separated.


\subsection{Results of spectral differential analysis}

\label{appendix:A2}
We applied the spectral differential procedure outlined above on the wavelength-calibrated and telluric-corrected CRIRES observations. The spectra were corrected for Earth's barycentric RV using the \emph{helcor} PyAstronomy\footnote{https://pyastronomy.readthedocs.io} function ported from the REDUCE IDL package (See \citet[][]{piskunov_new_2002}) and Doppler shifted to the rest frame velocity of the system. The spectra were then subtracted from each other and analyzed as described above.

It is necessary to have a consistent instrumental setup \citet{ferluga_separating_1997}, to avoid introducing extra instrumental effects (e.g. slit-width and/or filters) into the spectral differentials and to always observe the same wavelength range and maximize the information to be extracted. In our case, the second observation of \object{HD 202206} and fourth of \object{HD 30501} were taken with different filters compared to the other observations. Therefore, these two observations could not be used for this differential analysis. As noted in \citep{hadrava_disentangling_2009}, any spectral differences in the filters would add extra unknown signal/noise making it harder to disentangle the faint spectral differences.


\begin{figure}
	\includegraphics[width=\hsize]{figures/direct-recovery/differential.pdf}\\
	\caption{ (Top) A reduced CRIRES observation of \object{HD 30501} (blue) for detector 1 between 2112--2124~nm along with the tapas telluric absorption model ({orange} dashed) used for the wavelength calibration and telluric correction. (Middle) The telluric corrected spectra. (Bottom) ({blue}) Differential spectra for \object{HD 30501} between observations 1 and 3. ({orange} dashed) Simulated ``perfect'' differential using PHOENIX-ACES spectra with parameters \(T_{\textrm{eff}} = 2500~K \), \(\rm logg=5.0\), and \(\rm [Fe/H]=0.0 \), with the same \(\Delta RV \) as the observations. The shaded regions indicate where the telluric {green} and host star {blue} spectra are > 4\%  deep.}
	\label{fig:spectral_example}
\end{figure}


We performed the differential analysis for all targets but only show our most favorable case here, \object{HD 30501}, because it is the second largest companion in our sample at \(\rm 90~M_{Jup}\) and also has the second largest RV separation between observations. The differential spectra recovered for \object{HD 30501} is shown at the bottom panel of Fig.~\ref{fig:spectral_example}. The presence of deep (\(>4\% \)) stellar and telluric lines in the original spectrum is shaded by the blue and green regions respectively. This indicates that the features of the differential spectrum near these shaded regions are likely due to imperfect telluric correction and host mutual cancellation.
The mutual cancellation of the stellar host works well for the \(\sim40\% \) deep line near 2117~nm, being completely removed, but it does not do so well for the smaller \(\sim10\% \) deep line around 2121.5~nm. The residual for the large \(\sim40\% \) deep telluric line near 2118.5~nm is quite prominent. There is also a wider residual due to three neighboring lines \(\sim10\% \) deep around 2120~nm which cause features in the differential spectrum. One possible explanation is that the continuum normalization near 2120~nm was influenced by this grouping of lines.

To understand the observed differential signal we simulated a differential spectrum of \object{HD 30501} using a synthetic PHOENIX-ACES spectra with parameters \(T_{\textrm{eff}} = 2500~K \), \(\rm logg=5.0 \), and \(\rm [Fe/H]=0.0 \), with a RV offset estimated from the observation times. These parameters represent an estimated companion \(T_{\textrm{eff}} \) with the metallicity and logg similar to the host (closest grid model). The model spectra were convolved to \(\rm R=50\,000 \), continuum normalized and scaled by the estimated flux ratio of the companion. We do not include any synthetic host or telluric spectra and as such simulate the differential result of a ``perfect'' host cancellation with no telluric contamination present. This is the ideal-case scenario, and we stress that it is impossible to simulate the effect of improper telluric correction in a meaningful way. When comparing the simulated and observed differential in the bottom panel of Fig.~\ref{fig:spectral_example}, there is a striking amplitude difference. The orange-dashed line of the simulated differential spectrum amplitude is of a much smaller scale than the observed differential. This demonstrates that the amplitude of the differential signal we are trying to detect is much smaller than the residuals created by this differential technique.

The amplitude of the differential signal is lower than we expected due to the very low \(\Delta RV\) between the observation pairs. The maximum \(\Delta RV\) observed between pairs of all targets is provided in Table~\ref{tab:flux_table}.
In our best case, \object{HD 30501},  the \(\Delta RV\) of the companion between observations is 1.346~kms\(^{-1}\). For comparison, a single Gaussian absorption line, to be shifted by \(\Delta\lambda = \rm FWHM\) would need a \(\Delta RV\) of \(v_{\textrm{FWHM}} = c/R =~\sim6\)~kms\(^{-1}\). Since the \(\Delta RV\) are shifted by a smaller value than the FWHM, the spectral lines of the reconstruction mutually cancel themselves, diminishing the amplitude of the differential signal significantly. As the companion spectra are already faint (with a flux ratio at the percent level) the differential signal is not detectable within these observations and noise level.
When the \(\Delta RV \) of the companion is smaller than the FWHM of a line there is a mutual subtraction of the companion spectra, diminishing the detected amplitude of the differential signal, and removing the ability to detect the companions using this method. Observations need to be spaced further apart in time/phase to achieve a larger \(\Delta RV\) separation and increase the amplitude of the differential. Of course once there is a separation there will be complex interactions between neighboring lines that need to be accounted for.

\subsection{Relative differential amplitude}
To probe this issue further we investigated how the amplitude of the differential signal changed with \(\Delta RV \). Taking the same PHOENIX-ACES spectra (\(T_{\textrm{eff}} = 2500~K \), \(\rm logg=5.0 \), \(\rm [Fe/H]=0.0 \)), we computed differential spectra for a range of \(\Delta RV\)s between \(\pm10\)~kms\(^{-1}\). Figure~\ref{fig:diff_amp} shows how the relative amplitude of the differential spectrum in the wavelength range 2110--2123~nm (detector 1 of our CRIRES observations) changed as the spectra are offset. At each RV step we take the maximum absolute differential value found. These are then normalized by the median value outside of the line FWHM (dashed vertical lines), between \(\pm(7-10)\)~kms\(^{-1}\), to give a relative differential amplitude, independent from the depth of a specific line. For comparison we also show the relative amplitude of the differential spectrum for a single Gaussian and single Lorentzian line when Doppler shifted by the same \(\Delta RV \)s. The shape of these results is also consistent with the analytical form of the differential spectra \citet[][eqn.~A.1]{ferluga_separating_1997}.

At a \(\Delta RV\) difference of zero, spectral lines of the companion completely cancel each other out, resulting in zero amplitude. As the RV separation increases, the individual lines stop canceling themselves until a maximum differential amplitude is achieved when the lines are fully separated from themselves (equal to the line depth). 

The two solid vertical lines in Fig.~\ref{fig:diff_amp} indicate the estimated \(\Delta \textrm{RV}\)=1.34~kms\(^{-1}\) separation for our best target, \object{HD 30501} from Table~\ref{tab:flux_table} , given known orbital parameters and the observation times. This shows that our differentials have severely reduced amplitude, \(<20\%\) relative to well separated individual lines. As the companion spectra are faint and in combination with a host star at 1\% flux ratio the >80\% extra reduction in signal amplitude makes this detection impossible with these observations.

In the synthetic spectrum (and of course real spectra) neighboring spectral lines begin to interfere, leading to an impact on the measured relative amplitude. We suspect that the interaction of neighboring lines is one possible cause for the difference between the theoretical and simulated shape between 2 and 6~kms\(^{-1}\). Beyond the RV range present the amplitude becomes complicated due to neighboring line interaction, but as the \(\Delta RV\) for all our spectra fall well short of this region we did not investigate this further.

\begin{figure}
	\includegraphics[width=0.45\textwidth]{figures/direct-recovery/rv_diff_final.pdf}
	\caption{Simulated relative amplitude of differential spectra at different RV separations revealing the diminished amplitude at small orbital separations. The solid blue line shows the maximum relative amplitude of the differential signal (from a shifted copy of itself) of a PHOENIX-ACES spectrum with \(T_{\textrm{eff}}=2500~K, logg=5.0, [Fe/H]=0.0\) in the wavelength region 2110--2123~nm. The maximum difference is normalized by the average amplitude between 7--10~kms\(^{-1}\), representing a complete line separation. The orange (dashed) and green (dot-dashed) lines represent the relative amplitude of a differential spectrum of a spectrum containing a single Gaussian and single Lorentzian absorption line respectively, each with a unitary amplitude and a \(\rm FWHM = \lambda / R \). Beyond the FWHM lines the difference of the synthetic spectrum becomes more complicated due to the interaction of neighboring lines. The solid vertical lines indicate the estimated companion \(\Delta RV\) in these observations while the dashed vertical lines indicate the RV corresponding to the FWHM at this wavelength and resolution. Beyond the FWHM RV the synthetic spectrum becomes complicated due to the interaction of neighboring lines.}
	
	\label{fig:diff_amp}
\end{figure}
\unfinished{Increase size of diff amp plots to two}

\unfinished{Try show differences for all targets /all chips?}

\subsection{RV calculation}
\unfinished{Move location / adjust from paper}
To determine the RV offset to apply to the simulated spectra above we calculated the RV of the companion using the published orbital parameters of the host, transforming the RV semi-amplitude of the host \(K_{1} \) into the companion semi-amplitude \(K_{2} \) using the mass ratio,
\begin{equation}
\label{eqn:mass_ratio}
q = \textrm{M}_{2} / \textrm{M}_{1} = \textrm{K}_{1} / \textrm{K}_{2}
\end{equation}

We note that for the targets in which only the minimum mass (\(\textrm{M}\sin{i} \)) is known, this equation will indicate the maximum \(K_2\) value for the companion. The estimated \(K_2\) value for each companion is given in Table~\ref{tab:flux_table} while the estimated RV for each observation is calculated in Table~\ref{tab:observations}.

If a direct measurement of the companion RV or \(\Delta RV \) from the differential spectra analysis was achieved, then this relation would have been used to calculate the companion mass.

The error on estimated RV values is calculated using the general error propagation formula \citep{ku_notes_1966} with the RV equation and the errors on the orbital parameters. For a function, \(f\), with errors on the inputs \(\delta x\), \(\delta y\) etc, it follows: 
\begin{align}
	f &= f(x, y, z, ...)\\
	\delta f &= \sqrt{{\left( \frac{\partial f}{\partial x} \delta x\right)}^2 +  {\left(\frac{\partial f}{\partial y} \delta y\right)}^2 + {\left(\frac{\partial f}{\partial z} \delta z\right)}^2 + ...}
\end{align}  


\section{Estimating Companion-host Flux ratio}

\unfinished{Move location / adjust from paper}
\label{compaion flux ration}
The companion-host flux or contrast ratio of the systems are calculated using \( \frac{F_{2}}{F_{1}} \approx 2.512^{m_{1}-m_{2}} \), where \(m_{1} \) and \(m_{2} \) are the magnitude of the host and companion respectively.\ \(m_{1} \) is the magnitude of the host in the literature, while \(m_{2} \) is obtained from stellar evolution models of \citet{baraffe_evolutionary_2003, baraffe_new_2015}, using the companion mass (or \(M_{2}\sin{i}\))) and the host's age. If only the companion minimum mass is known then this will correspond to the flux ratio lower limit, (or worst case scenario). The models, interpolated to the companion mass, also provide a first estimate of companion properties such as \(T_{\textrm{eff}}\), logg, \(R/R_{\sun}\) and the magnitude in many wavelength bands.
We use the K-band magnitude specifically for this work to estimate the flux ratio between the host and companion using the host K-band magnitude obtained from SIMBAD \citep{wenger_simbad_2000}. Our flux ratio estimates are presented in table~\ref{tab:flux_table}.
The companion \(T_{\textrm{eff}}\) and logg values specifically are used to influence the selection of synthetic model grids to perform the \(\chi^2\) analysis over.

A simple tool\footnote{Available at \url{https://github.com/jason-neal/baraffe_tables}} was created to estimate the flux ratio using the \citep{baraffe_evolutionary_2003,baraffe_new_2015} evolution tables. Given the host star name, the companion mass and a stellar age it interpolates the available Baraffe tables to the companion mass and age specified. The host's name is used to query the SIMBAD database to obtain stellar properties, specifically magnitudes, to calculate the flux ratios. It can also work in reverse to estimate the companion mass when provided with a flux ratio value.





\section{Direct recovery in the MIR}
Early on in 2015 we began investigating extending this technique to the MIR. In particular looked at applying for observing time with a MIR instrument to perform similar work.

We investigating applying for time with VISIR.

VISIR is a MIR spectroscopy with resolution ... and

Looking at the best candidates XXXX was chosen a a likely target. I calculated flux ratios and performance considerations we determined that observations with VISIR to achieve a SNR of 100 were unfeasible, requiring 1000's of hours observing time.

The goal would be to observe with High-resolution and high through-put spectrographs. Ideally with CRIRES+, which at the times was scheduled for 2017. Currently\footnote{June 2018} first light is scheduled for Q1 2019.




